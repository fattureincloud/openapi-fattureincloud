name: Bump and Publish OpenAPI to Readme
on:
  push:
    branches:
      - master
  workflow_dispatch
jobs:
  bump-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v2
      # - name: Setup Python
      #   uses: actions/setup-python@v2
      - name: Setup Node.js
        uses: actions/setup-node@v2
      - name: Setup Java
        uses: actions/setup-java@v2
        with:
          distribution: 'adopt'
          java-version: '8'
      - name: Init GIT
        run: |
          git config --global user.email "info@fattureincloud.it"
          git config --global user.name "Github Action"
      - name: Install libraries
        run: |
          npm install -g yarn
          yarn global add @apidevtools/swagger-cli @openapitools/openapi-generator-cli standard-version
          add-apt-repository ppa:rmescandon/yq -y
          apt update
          apt install yq -y
      - name: Validate schema
        run: |
          swagger-cli validate openapi.yaml
          openapi-generator-cli validate -i ./openapi.yaml
      - name: Bump OpenAPI spec version
        run: |
          cd .github/workflows/scripts/
          yarn
          CURR_VER=$(yq e '.info.version' ../../../openapi.yaml)
          echo "Previous version: $CURR_VER"
          yarn release
          BUMP_VER=$(yq e '.info.version' ../../../openapi.yaml)
          echo "New version: $BUMP_VER"
      - name: Run Readme Versions Manager Script
        run: |
          cd .github/workflows/scripts/
          yarn specid >> $GITHUB_ENV
      - name: Test step
        run: |
          echo "${{ env.api_version }}"
          echo "${{ env.oas_key }}"



      # - name: Upload to Readme.io
      #   uses: readmeio/github-readme-sync@v2
      #   if: ${{ !env.ACT }}
      #   with:
      #     readme-oas-key: "${{ env.oas_key }}"
      #     oas-file-path: './openapi.yaml'
          # OPTIONAL CONFIG, use if necessary
          # api-version: 'v1.0.0'
        
      # - name: Generate Java SDK
      #   run: |
      #     mkdir -p ../generated/java
      #     git clone https://Valmoz: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@github.com/fattureincloud/test-target-repo.git ../generated/java
      #     openapi-generator-cli generate -i ./openapi.yaml -g java -o ../generated/java
      #     echo "TEST" > ../generated/java/test.txt
      #     cd ../generated/java
      #     git add .
      #     git commit -m "TODO COMMIT MESSAGE"
      #     git push -u origin main

      # - name: Generate Python SDK
      #   run: |
      #     mkdir -p ../generated/python
      #     git clone https://Valmoz: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@github.com/fattureincloud/test-target-repo-py.git ../generated/python
      #     openapi-generator-cli generate -i ./openapi.yaml -g python -o ../generated/python
      #     cd ../generated/python
      #     git add .
      #     git commit -m "TODO COMMIT MESSAGE"
      #     git push -u origin main


      # - name: INIT REPO
      #   run: |
      #     mkdir -p ../generated/python
      #     openapi-generator-cli generate -i ./openapi.yaml -g python -o ../generated/python
      #     cd ../generated/python
      #     echo "@@@@@@@@@@@@@@@@"
      #     pwd
      #     echo "@@@@@@@@@@@@@@@@"
      #     ls 
      #     echo "@@@@@@@@@@@@@@@@"
      #     git init
      #     git add .
      #     git commit -m "First commit."
      #     git branch -M main
      #     git remote add origin https://Valmoz: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@github.com/fattureincloud/test-target-repo-py.git
      #     git push -u origin main

      # - name: Generate Java SDK
      #   run: |
      #     mkdir -p ../generated/java
      #     git clone https://Valmoz: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@github.com/fattureincloud/test-target-repo.git ../generated/java
      #     openapi-generator-cli generate -i ./openapi.yaml -g java -o ../generated/java
      #     echo "TEST" > ../generated/java/test.txt
      #     cd ../generated/java
      #     mvn javadoc:javadoc
      #     git add .
      #     git commit -m "TODO COMMIT MESSAGE"
      #     git push -u origin main

      # - name: INIT REPO
      #   run: |
      #     git init
      #     git add .
      #     git commit -m "First commit."
      #     git branch -M main
      #     git remote add origin https://Valmoz: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@github.com/fattureincloud/test-target-repo.git
      #     git push -u origin main

